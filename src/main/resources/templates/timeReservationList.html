<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>예약 시스템</title>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    .time-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    .time-buttons button {
      padding: 8px;
      border: 1px solid #ccc;
      background: #f8f8f8;
      cursor: pointer;
    }
    .time-buttons button.selected {
      background: #007bff;
      color: white;
    }
    .time-buttons button.disabled {
      background: #ddd;
      color: #777;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

<h2>예약 시스템</h2>

<form id="reservationForm">
  <label>날짜 선택:</label>
  <div id="datePickerContainer"></div>

  <label>시간 선택:</label>
  <div id="timeButtons" class="time-buttons"></div>

  <p><strong>선택한 시간:</strong> <span id="selectedTimeText">없음</span></p>

  <button type="submit" id="reserveButton" disabled>예약하기</button>
</form>

<p id="responseMessage" style="color: green;"></p>

<script>
  let today = new Date();
  let maxDate = new Date();
  maxDate.setDate(today.getDate() + 60);

  let disabledDates = ["2025-02-12", "2025-02-13"];
  let disabledTimes = ["12:00", "12:30", "18:00", "18:30"];

  let selectedDate = null;
  let selectedStartTime = null;
  let selectedEndTime = null;

  function updateReserveButtonState() {
    document.getElementById("reserveButton").disabled = !(selectedDate && selectedStartTime && selectedEndTime);
  }

  function renderTimeButtons() {
    const timeContainer = document.getElementById("timeButtons");
    timeContainer.innerHTML = "";

    let times = [];
    for (let hour = 9; hour <= 21; hour++) {
      times.push(`${hour.toString().padStart(2, '0')}:00`);
      times.push(`${hour.toString().padStart(2, '0')}:30`);
    }

    times.forEach(time => {
      let btn = document.createElement("button");
      btn.textContent = time;

      if (disabledTimes.includes(time)) {
        btn.classList.add("disabled");
        btn.disabled = true;
      } else {
        btn.onclick = function() {
          selectTime(time);
        };
      }

      timeContainer.appendChild(btn);
    });
  }

  function selectTime(time) {
    let buttons = Array.from(document.querySelectorAll("#timeButtons button:not(.disabled)"));
    let timeList = buttons.map(b => b.textContent);
    let timeIndex = timeList.indexOf(time);

    if (!selectedStartTime) {
      // 첫 번째 선택 → startTime 설정
      selectedStartTime = time;
      selectedEndTime = null;
    } else if (!selectedEndTime) {
      if (isTimeBlocked(selectedStartTime, time)) {
        alert("불가능한 시간이 범위에 포함됩니다!");
        return;
      }
      selectedEndTime = time;
    } else {
      let startIndex = timeList.indexOf(selectedStartTime);
      let endIndex = timeList.indexOf(selectedEndTime);

      if (timeIndex < startIndex) {
        // 선택한 시간이 startTime보다 이전이면 → 기존 startTime이 endTime이 되고 새 startTime 설정
        selectedEndTime = selectedStartTime;
        selectedStartTime = time;
      } else if (timeIndex > endIndex) {
        // 선택한 시간이 endTime 이후면 → 새로운 endTime 설정
        selectedEndTime = time;
      } else {
        // 중간을 클릭하면 다시 시작
        selectedStartTime = time;
        selectedEndTime = null;
      }
    }

    updateSelectedTimeRange();
    updateReserveButtonState();
  }

  function isTimeBlocked(start, end) {
    let buttons = Array.from(document.querySelectorAll("#timeButtons button"));
    let startIndex = buttons.findIndex(b => b.textContent === start);
    let endIndex = buttons.findIndex(b => b.textContent === end);

    for (let i = startIndex + 1; i < endIndex; i++) {
      if (buttons[i].classList.contains("disabled")) return true;
    }
    return false;
  }

  function updateSelectedTimeRange() {
    let buttons = document.querySelectorAll("#timeButtons button:not(.disabled)");
    buttons.forEach(b => b.classList.remove("selected"));

    if (selectedStartTime && selectedEndTime) {
      let selecting = false;
      buttons.forEach(b => {
        if (b.textContent === selectedStartTime) selecting = true;
        if (selecting) b.classList.add("selected");
        if (b.textContent === selectedEndTime) selecting = false;
      });

      document.getElementById("selectedTimeText").textContent = `${selectedStartTime} ~ ${selectedEndTime}`;
    } else if (selectedStartTime) {
      document.getElementById("selectedTimeText").textContent = `${selectedStartTime} ~ ?`;
    } else {
      document.getElementById("selectedTimeText").textContent = "없음";
    }
  }

  flatpickr("#datePickerContainer", {
    inline: true,
    dateFormat: "Y-m-d",
    minDate: "today",
    maxDate: maxDate,
    disable: disabledDates,
    onChange: function(selectedDates) {
      if (selectedDates.length === 1) {
        selectedDate = selectedDates[0].toISOString().split("T")[0];
        selectedStartTime = null;
        selectedEndTime = null;
        renderTimeButtons();
        updateSelectedTimeRange();
        updateReserveButtonState();
      }
    }
  });

  document.getElementById("reservationForm").addEventListener("submit", function(event) {
    event.preventDefault(); // 기본 제출 동작 막기 (페이지 이동 X)

    if (!selectedDate || !selectedStartTime || !selectedEndTime) {
      alert("날짜와 시간을 모두 선택하세요!");
      return;
    }

    let reservationData = {
      date: selectedDate,
      startTime: selectedStartTime,
      endTime: selectedEndTime
    };

    fetch("/reserve", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(reservationData)
    })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                document.getElementById("responseMessage").textContent = "✅ 예약 완료!";
              } else {
                document.getElementById("responseMessage").textContent = "❌ 예약 실패: " + data.message;
              }
            })
            .catch(error => {
              console.error("Error:", error);
              document.getElementById("responseMessage").textContent = "❌ 서버 오류 발생!";
            });
  });

</script>

</body>
</html>
